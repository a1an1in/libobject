To make producer reentrant

Description:
there still have some issue, will modify later, since i
haven't found good solution.

Major Changes:
update